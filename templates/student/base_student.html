{% load static %}
<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>{% block title %}ENSIAS Mobilité{% endblock %}</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link href="{% static 'css/app.css' %}" rel="stylesheet">
</head>

<body class="student-shell">

  <!-- Topbar -->
  <header class="student-topbar">
    <div class="student-brand">
      <div class="student-brand-logo">
        <img src="{% static 'img/ensias-logo.jpg' %}" alt="ENSIAS" />
      </div>
      <div>
        <div class="student-brand-title">ENSIAS Mobilité</div>
        <div class="student-brand-sub">Gestion de la Mobilité Internationale</div>
      </div>
    </div>

    <div class="student-topbar-actions">
      <a class="student-icon-btn" href="{% url 'notif_inbox' %}" title="Notifications">
        <i class="bi bi-bell"></i>
        {% if user.unread_notifications_count %}
          <span class="student-badge">{{ user.unread_notifications_count }}</span>
        {% endif %}
      </a>

      <div class="student-user-pill">
        <span class="student-user-role">
          {% if user.role == 'STUDENT' %}Étudiant{% else %}{{ user.role }}{% endif %}
        </span>
        <a class="student-logout" href="{% url 'logout' %}" title="Déconnexion">
          <i class="bi bi-box-arrow-right"></i>
        </a>
      </div>

      <button class="btn btn-sm btn-outline-primary d-lg-none" type="button" data-bs-toggle="offcanvas" data-bs-target="#studentSidebar" aria-controls="studentSidebar">
        <i class="bi bi-list"></i>
      </button>
    </div>
  </header>

  <div class="student-layout">

    <!-- Sidebar desktop -->
    <aside class="student-sidebar d-none d-lg-flex">
      {% include 'student/partials/sidebar.html' %}
    </aside>

    <!-- Sidebar mobile (offcanvas) -->
    <div class="offcanvas offcanvas-start" tabindex="-1" id="studentSidebar" aria-labelledby="studentSidebarLabel">
      <div class="offcanvas-header">
        <h5 class="offcanvas-title" id="studentSidebarLabel">Menu</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
      </div>
      <div class="offcanvas-body">
        {% include 'student/partials/sidebar.html' %}
      </div>
    </div>

    <!-- Content -->
    <main class="student-content">
      {% for message in messages %}
        <div class="alert alert-{{ message.tags }} rounded-4 shadow-sm">{{ message }}</div>
      {% endfor %}

      {% block content %}
        {% block student_content %}{% endblock %}
      {% endblock %}
    </main>
  </div>

  <button class="chatbot-toggle" type="button" id="chatbotToggle" title="Assistant">
    <i class="bi bi-robot"></i>
  </button>

  <div class="chatbot-widget" id="chatbotWidget" data-api="{% url 'student_chatbot_api' %}">
    <div class="chatbot-widget-header">
      <span>Assistant ENSIAS</span>
      <button class="btn btn-sm btn-light" type="button" id="chatbotClose">Fermer</button>
    </div>
    <div class="chatbot-widget-body">
      <div class="chatbot-messages" id="chatbotWidgetMessages">
        <div class="chat-msg bot">
          <div class="bubble">Bonjour, je peux aider sur phases, documents, desiderata et resultats.</div>
        </div>
      </div>
      <div class="chatbot-faq">
        <button type="button" data-q="Quelle est la phase actuelle ?">Phase actuelle</button>
        <button type="button" data-q="Quels documents dois-je fournir ?">Documents requis</button>
        <button type="button" data-q="Comment remplir mes desiderata ?">Desiderata</button>
      </div>
    </div>
    <form class="chatbot-input" id="chatbotWidgetForm">
      {% csrf_token %}
      <input class="form-control" id="chatbotWidgetInput" placeholder="Ecrivez votre message..." autocomplete="off" />
      <button class="btn btn-primary" type="submit"><i class="bi bi-send"></i></button>
    </form>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    (function(){
      const toggle = document.getElementById("chatbotToggle");
      const widget = document.getElementById("chatbotWidget");
      if(!toggle || !widget) return;

      const closeBtn = document.getElementById("chatbotClose");
      const form = document.getElementById("chatbotWidgetForm");
      const input = document.getElementById("chatbotWidgetInput");
      const messages = document.getElementById("chatbotWidgetMessages");
      const api = widget.getAttribute("data-api");

      function addMsg(text, who){
        const wrap = document.createElement("div");
        wrap.className = `chat-msg ${who}`;
        wrap.innerHTML = `<div class="bubble"></div>`;
        wrap.querySelector(".bubble").textContent = text;
        messages.appendChild(wrap);
        messages.scrollTop = messages.scrollHeight;
      }

      function getCsrf(){
        const el = form.querySelector("input[name=csrfmiddlewaretoken]");
        return el ? el.value : "";
      }

      async function sendMessage(text){
        if(!text) return;
        addMsg(text, "user");
        try{
          const resp = await fetch(api, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-CSRFToken": getCsrf(),
            },
            body: JSON.stringify({message: text})
          });
          const data = await resp.json();
          addMsg(data.reply || data.answer || "Desole, je n'ai pas compris.", "bot");
        }catch(err){
          addMsg("Erreur de connexion. Reessayez.", "bot");
        }
      }

      toggle.addEventListener("click", () => {
        widget.classList.toggle("open");
      });
      if(closeBtn){
        closeBtn.addEventListener("click", () => widget.classList.remove("open"));
      }

      form.addEventListener("submit", (e) => {
        e.preventDefault();
        const text = input.value.trim();
        input.value = "";
        sendMessage(text);
      });

      widget.querySelectorAll(".chatbot-faq button").forEach((btn) => {
        btn.addEventListener("click", () => sendMessage(btn.dataset.q || ""));
      });
    })();
  </script>
  {% block extra_js %}{% endblock %}
</body>
</html>
